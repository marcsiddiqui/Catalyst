name: Build and deploy ASP.Net Core app on a FTP

env:
  DOTNET_VERSION: '9.0.x'                 # set this to the .NET Core version to use
  PUBLISHED_PATH: ./publish_output
  LOCAL_APP_OFFLINE_PATH: ./App_offline/app_offline.htm
  REMOTE_DIRECTORY: /httpdocs
  FTP_HOST: '66.165.248.146'
  FTP_USERNAME: 'samimaap'
  FTP_PASSWORD: 'QhnCr~kmSe8^z07p'
  LFTP_SSL_ALLOW: "no"
  LFTP_PASSIVE_MODE: "on"

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  # upload-app-offline:
  #     permissions:
  #       contents: none
  #     runs-on: ubuntu-latest
  
  #     steps:
  #       - uses: actions/checkout@v4
      
  #       - name: Check temp app offline exists
  #         run: ls -la ${{ env.LOCAL_APP_OFFLINE_PATH }}
          
  #       - name: Upload app_offline.htm to FTP
  #         uses: anvil-solutions/Fast-FTP-Action@2.1.3
  #         with:
  #           server: ${{ env.FTP_HOST }}
  #           username: ${{ env.FTP_USERNAME }}
  #           password: ${{ env.FTP_PASSWORD }}
  #           method: ftp
  #           local_dir: ${{ env.LOCAL_APP_OFFLINE_PATH }}
  #           remote_dir: ${{ env.REMOTE_DIRECTORY }}
  build:
    runs-on: ubuntu-latest
    # needs: upload-app-offline
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up .NET Core
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Set up dependency caching for faster builds
        uses: actions/cache@v3
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Build with dotnet
        run: dotnet build --configuration Release

      - name: dotnet publish
        run: dotnet publish -c Release -o ${{ env.PUBLISHED_PATH }}
      
      - name: Upload artifact for deployment job
        uses: actions/upload-artifact@v4
        with:
          name: .net-app
          path: ${{ env.PUBLISHED_PATH }}
          
  deploy:
    permissions:
      contents: none
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: 'Development'
      url: ${{ steps.deploy-to-webapp.outputs.webapp-url }}

    steps:
      # ----------------------------------------------------
      # Install lftp (FTP CLI tool used for precise control)
      # ----------------------------------------------------
      - name: Install lftp
        run: sudo apt-get update && sudo apt-get install -y lftp
    
      # ----------------------------------------------------
      # Upload app_offline.htm ONLY if it does not already exist
      # Prevents overwriting an existing maintenance mode file
      # ----------------------------------------------------
      - name: Upload app_offline.htm only if missing
        run: |
          lftp -u "${{ env.FTP_USERNAME }},${{ env.FTP_PASSWORD }}" ${{ env.FTP_HOST }} <<EOF
          # Disable SSL (plain FTP)
          set ftp:ssl-allow ${{ env.LFTP_SSL_ALLOW }}
    
          # Enable passive mode (firewall friendly)
          set ftp:passive-mode ${{ env.LFTP_PASSIVE_MODE }}
    
          # Check if file exists remotely; upload only if missing
          cls ${{ env.REMOTE_APP_OFFLINE_FILE }} || \
          put ${{ env.LOCAL_APP_OFFLINE_PATH }} \
              -o ${{ env.REMOTE_APP_OFFLINE_FILE }}
    
          bye
          EOF
    
      # ----------------------------------------------------
      # Download build artifacts from previous job
      # ----------------------------------------------------
      - name: Download artifact from build job
        uses: actions/download-artifact@v4
        with:
          name: .net-app
          path: ${{ env.PUBLISHED_PATH }}
    
      # ----------------------------------------------------
      # Verify publish output exists (debug / safety check)
      # ----------------------------------------------------
      - name: Check publish output exists
        run: ls -la ${{ env.PUBLISHED_PATH }}
    
      # ----------------------------------------------------
      # Upload published application using lftp mirror
      # -R  = reverse mirror (local â†’ remote)
      # NO --delete flag (safe for production)
      # ----------------------------------------------------
      - name: Upload publish folder using lftp
        run: |
          lftp -u "${{ env.FTP_USERNAME }},${{ env.FTP_PASSWORD }}" ${{ env.FTP_HOST }} <<EOF
          set ftp:ssl-allow ${{ env.LFTP_SSL_ALLOW }}
          set ftp:passive-mode ${{ env.LFTP_PASSIVE_MODE }}
    
          mirror -R ${{ env.PUBLISHED_PATH }} ${{ env.REMOTE_DIRECTORY }}
    
          bye
          EOF
    
      # ----------------------------------------------------
      # Remove app_offline.htm to bring site back online
      # "|| true" ensures pipeline does not fail if file is missing
      # ----------------------------------------------------
      - name: Remove app_offline.htm (safe)
        run: |
          lftp -u "${{ env.FTP_USERNAME }},${{ env.FTP_PASSWORD }}" ${{ env.FTP_HOST }} <<EOF
          set ftp:ssl-allow ${{ env.LFTP_SSL_ALLOW }}
          set ftp:passive-mode ${{ env.LFTP_PASSIVE_MODE }}
    
          rm ${{ env.REMOTE_APP_OFFLINE_FILE }} || true
    
          bye
          EOF
